name: Build image on tag

on:
  push:
    tags: ['v*.*.*', 'v*.*.*.*']  # Запуск при пуше тегов типа v1.0.0, v1.2.3, v1.0.0-beta.1
  workflow_dispatch:

env:
  DOCKER_CONTAINER_NAME: ${{ vars.DOCKER_CONTAINER_NAME }}
  APP_FILE: ${{ vars.APP_FILE }}
  BIN_NAME: ${{ vars.BIN_NAME }}
  DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}
  DOCKER_NAMESPACE: ${{ vars.DOCKER_NAMESPACE }}

jobs:
  Test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Получить всю историю коммитов для корректной работы с тегами
    
    - uses: actions/setup-go@v6
      with:
        go-version: '1.23'
    
    - name: Test
      run: make test

  Publish:
    needs: [Test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
    
    - name: Extract tag version
      id: extract_tag
      run: |
        # Получаем имя тега из контекста GitHub
        TAG_NAME="${{ github.ref_name }}"
        
        # Убираем префикс 'v' если он есть (v1.0.0 → 1.0.0)
        if [[ $TAG_NAME == v* ]]; then
          VERSION="${TAG_NAME#v}"
        else
          VERSION="$TAG_NAME"
        fi
        
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "Tag name: $TAG_NAME"
        echo "Version: $VERSION"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image to GHCR
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/${{ vars.DOCKER_IMAGE_NAME }}:latest
          ghcr.io/${{ github.repository_owner }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ env.VERSION }}
          ghcr.io/${{ github.repository_owner }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ env.TAG_NAME }}
        labels: |
          org.opencontainers.image.version=${{ env.VERSION }}
          org.opencontainers.image.revision=${{ github.sha }}